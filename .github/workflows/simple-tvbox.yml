name: Simple TVBox Update

on:
  schedule:
    - cron: '0 19 * * *'   # UTC 19:00 → 北京时间 03:00
  workflow_dispatch:

concurrency:
  group: tvbox-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      # 1. 拉取仓库代码（后面会挂载进去）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 运行 TVBox 容器（内部已自带 run.py）
      - name: Run TVBox Docker
        run: |
          echo "开始运行容器..."
          docker run --rm \
            -v ${{ github.workspace }}:/data \
            -e username=${{ github.repository_owner }} \
            -e token=${{ secrets.GITHUB_TOKEN }} \
            -e repo=tvbox \
            -e url='http://pandown.pro/tvbox/tvbox.json' \
            -e mirror=1 \
            -e num=1 \
            -e target=tvbox \
            2011820123/tvbox:latest \
            python /run.py   # 直接调用容器内部脚本

      # 3. 验证生成的文件
      - name: Verify Update
        if: always()
        run: |
          echo "## 更新验证结果" >> $GITHUB_STEP_SUMMARY
          if [ -f "tvbox.json" ]; then
            echo "### tvbox.json 已生成，大小: $(wc -c < tvbox.json) 字节" >> $GITHUB_STEP_SUMMARY
            echo "#### 最后 5 行预览:" >> $GITHUB_STEP_SUMMARY
            tail -5 tvbox.json >> $GITHUB_STEP_SUMMARY
          else
            echo "### tvbox.json 未找到" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "all.json" ]; then
            echo "### all.json 已生成，大小: $(wc -c < all.json) 字节" >> $GITHUB_STEP_SUMMARY
          else
            echo "### all.json 未找到" >> $GITHUB_STEP_SUMMARY
          fi
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "容器运行结束，请刷新仓库查看文件。" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      # 4. 失败时自动创建 Issue
      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'TVBox 更新失败',
              body: `工作流 "${{ github.workflow }}" 在 ${{ github.run_id }} 运行失败。\n日志：${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            })
