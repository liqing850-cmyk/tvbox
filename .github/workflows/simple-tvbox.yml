name: Simple TVBox Update

on:
  schedule:
    - cron: '0 19 * * *'   # 北京时间 03:00
  workflow_dispatch:

concurrency:
  group: tvbox-update
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run TVBox Docker
        run: |
          echo "开始运行容器..."
          docker run --rm \
            -v ${{ github.workspace }}:/data \
            -e username=${{ github.repository_owner }} \
            -e token=${{ secrets.GITHUB_TOKEN }} \
            -e repo=tvbox \
            -e url='http://pandown.pro/tvbox/tvbox.json' \
            -e mirror=1 \
            -e num=1 \
            -e target=tvbox \
            2011820123/tvbox:latest \
            python /run.py

      - name: Commit & Push if files changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add tvbox.json all.json 2>/dev/null || echo "No files to add"
          if git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Auto update TVBox config $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "Files updated and pushed!"
          fi

      - name: Verify Update
        if: always()
        run: |
          echo "## 更新验证结果" >> $GITHUB_STEP_SUMMARY
          if [ -f "tvbox.json" ]; then
            echo "### tvbox.json 已生成，大小: $(wc -c < tvbox.json) 字节" >> $GITHUB_STEP_SUMMARY
            echo "#### 最后 5 行预览:" >> $GITHUB_STEP_SUMMARY
            tail -5 tvbox.json >> $GITHUB_STEP_SUMMARY
          else
            echo "### tvbox.json 未找到" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "all.json" ]; then
            echo "### all.json 已生成，大小: $(wc -c < all.json) 字节" >> $GITHUB_STEP_SUMMARY
          else
            echo "### all.json 未找到" >> $GITHUB_STEP_SUMMARY
          fi
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "容器运行结束，文件已自动提交。" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'TVBox 更新失败',
              body: `工作流在 ${{ github.run_id }} 失败。\n日志：${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            })
