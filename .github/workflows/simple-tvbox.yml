name: Simple TVBox Update
on:
  schedule:
    - cron: '0 19 * * *' # 每天北京时间凌晨 3 点自动更新 (UTC 19:00)
  workflow_dispatch: # 允许手动触发
concurrency:
  group: tvbox-update
  cancel-in-progress: true
jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 确保 GITHUB_TOKEN 有写权限
      issues: write # 允许创建 Issue 通知失败
    steps:
      - name: Setup Git Auth in Container
        run: |
          # 创建一个 wrapper 脚本，强制设置 git remote 带 token
          cat > /tmp/docker-entry.sh << 'EOF'
          #!/bin/bash
          set -e
          export GIT_REMOTE="https://${{ github.repository_owner }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository_owner }}/${{ env.repo }}.git"
          # 在容器内运行原命令，但替换 push 部分
          docker run --rm \
            -e username=${{ github.repository_owner }} \
            -e token=${{ secrets.GITHUB_TOKEN }} \
            -e repo=tvbox \
            -e url='http://pandown.pro/tvbox/tvbox.json' \
            -e mirror=1 \
            -e num=1 \
            -e target=tvbox \
            -v /tmp/git-config:/tmp/git-config \
            2011820123/tvbox:latest /bin/sh -c "
              # 克隆后立即设置 remote
              git remote set-url origin \$GIT_REMOTE
              # 然后执行原逻辑（假设原脚本是 entrypoint）
              exec /原脚本路径
            "
          EOF
          chmod +x /tmp/docker-entry.sh
      - name: Run TVBox Docker (Internal Clone & Push)
        run: /tmp/docker-entry.sh  # 用 wrapper 运行
      # ... 其余步骤不变
